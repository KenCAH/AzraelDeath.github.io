<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>NIRVANA</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Blog of a Chinese OIer">
<meta property="og:type" content="website">
<meta property="og:title" content="NIRVANA">
<meta property="og:url" content="http://yoursite.com/page/9/index.html">
<meta property="og:site_name" content="NIRVANA">
<meta property="og:description" content="Blog of a Chinese OIer">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="NIRVANA">
<meta name="twitter:description" content="Blog of a Chinese OIer">
  
    <link rel="alternative" href="/atom.xml" title="NIRVANA" type="application/atom+xml">
  
  
    <link rel="icon" href="http://chuantu.biz/t6/89/1507626502x2728279003.jpg">
  
  <link rel="stylesheet" href="/css/style.css">
  
  

  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://chuantu.biz/t6/89/1507626502x2728279003.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Azrael_Death</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Veni Vidi Vici</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/AzraelDeath" title="github">github</a>
					        
								<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/azraeldeath" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/2-SAT/" style="font-size: 11.25px;">2-SAT</a> <a href="/tags/AC自动机/" style="font-size: 11.25px;">AC自动机</a> <a href="/tags/APIO/" style="font-size: 10px;">APIO</a> <a href="/tags/BZOJ/" style="font-size: 20px;">BZOJ</a> <a href="/tags/DFS序/" style="font-size: 10px;">DFS序</a> <a href="/tags/DP/" style="font-size: 11.25px;">DP</a> <a href="/tags/HDU/" style="font-size: 13.75px;">HDU</a> <a href="/tags/LCA/" style="font-size: 12.5px;">LCA</a> <a href="/tags/LG/" style="font-size: 11.25px;">LG</a> <a href="/tags/MST/" style="font-size: 12.5px;">MST</a> <a href="/tags/Manacher/" style="font-size: 11.25px;">Manacher</a> <a href="/tags/NOI/" style="font-size: 11.25px;">NOI</a> <a href="/tags/NOIp/" style="font-size: 11.25px;">NOIp</a> <a href="/tags/POI/" style="font-size: 10px;">POI</a> <a href="/tags/POJ/" style="font-size: 16.25px;">POJ</a> <a href="/tags/Tarjan/" style="font-size: 11.25px;">Tarjan</a> <a href="/tags/Trie/" style="font-size: 10px;">Trie</a> <a href="/tags/UVa/" style="font-size: 10px;">UVa</a> <a href="/tags/主席树/" style="font-size: 13.75px;">主席树</a> <a href="/tags/二分答案/" style="font-size: 11.25px;">二分答案</a> <a href="/tags/分块/" style="font-size: 10px;">分块</a> <a href="/tags/差分/" style="font-size: 10px;">差分</a> <a href="/tags/差分约束系统/" style="font-size: 10px;">差分约束系统</a> <a href="/tags/并查集/" style="font-size: 11.25px;">并查集</a> <a href="/tags/总结/" style="font-size: 18.75px;">总结</a> <a href="/tags/搜索/" style="font-size: 10px;">搜索</a> <a href="/tags/树套树/" style="font-size: 11.25px;">树套树</a> <a href="/tags/树状数组/" style="font-size: 12.5px;">树状数组</a> <a href="/tags/模拟/" style="font-size: 11.25px;">模拟</a> <a href="/tags/省选/" style="font-size: 17.5px;">省选</a> <a href="/tags/线段树/" style="font-size: 12.5px;">线段树</a> <a href="/tags/组合数学/" style="font-size: 10px;">组合数学</a> <a href="/tags/网络流/" style="font-size: 15px;">网络流</a> <a href="/tags/莫队/" style="font-size: 11.25px;">莫队</a> <a href="/tags/补集转换/" style="font-size: 10px;">补集转换</a> <a href="/tags/贪心/" style="font-size: 10px;">贪心</a> <a href="/tags/费用流/" style="font-size: 10px;">费用流</a> <a href="/tags/高斯消元/" style="font-size: 10px;">高斯消元</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.csdn.net/OwenOwl">OwenOwl</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.csdn.net/Joker_69">Joker</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://dangxingyu.com">DXY</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://309459245.lofter.com">YJQ</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/candy99">Candy</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/zig-zag">ZigZag</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://cxjyxx.me">cxjyxx_me</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.shuizilong.com">ShuiZiLong</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/kuangbin">KuangBin</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Azrael_Death</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://chuantu.biz/t6/89/1507626502x2728279003.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">Azrael_Death</h1>
			</hgroup>
			
			<p class="header-subtitle">Veni Vidi Vici</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/AzraelDeath" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/azraeldeath" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-BZOJ1012【JSOI2008】最大数 线段树" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/BZOJ1012【JSOI2008】最大数 线段树/" class="article-date">
  	<time datetime="2017-08-14T16:00:00.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/BZOJ1012【JSOI2008】最大数 线段树/">
        BZOJ1012【JSOI2008】最大数 &lt;线段树&gt;
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>最大数</p>
<p>题目描述<br>现在请求你维护一个数列，要求提供以下两种操作：<br>1、 查询操作。<br>语法：Q L<br>功能：查询当前数列中末尾L个数中的最大的数，并输出这个数的值。<br>限制：L不超过当前数列的长度。<br>2、 插入操作。<br>语法：A n<br>功能：将n加上t，其中t是最近一次查询操作的答案（如果还未执行过查询操作，则t=0)，并将所得结果对一个固定的常数D取模，将所得答案插入到数列的末尾。<br>限制：n是整数（可能为负数）并且在长整范围内。<br>注意：初始时数列是空的，没有一个数。</p>
<p>输入输出格式<br>输入格式：<br>第一行两个整数，M和D，其中M表示操作的个数(M &lt;= 200,000)，D如上文中所述，满足(0&lt;D&lt;2,000,000,000)<br>接下来的M行，每行一个字符串，描述一个具体的操作。语法如上文所述。<br>输出格式：<br>对于每一个查询操作，你应该按照顺序依次输出结果，每个结果占一行。</p>
<p>输入输出样例<br>输入样例：<br>5 100<br>A 96<br>Q 1<br>A 97<br>Q 1<br>Q 2<br>输出样例：<br>96<br>93<br>96</p>
</blockquote>
<p>标签：线段树</p>
<p>线段树裸题。<br>记录当前长度$len$，每个结点维护区间最大值，操作1为$query(len-L+1, len)$，操作2为$modify(++len, (n+t)%D)$。<br>注意开longlong</p>
<p>附上AC代码：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_N 200000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INF 2000000000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ll long long</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line">ll tree[MAX_N*<span class="number">4</span>+<span class="number">50</span>];</div><div class="line"><span class="keyword">int</span> n, len = <span class="number">0</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">updata</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;</div><div class="line">    tree[v] = max(tree[v&lt;&lt;<span class="number">1</span>], tree[v&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> s, <span class="keyword">int</span> t)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (s == t) &#123;</div><div class="line">        tree[v] = -INF;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> mid = s+t&gt;&gt;<span class="number">1</span>;</div><div class="line">    build(v&lt;&lt;<span class="number">1</span>, s, mid);</div><div class="line">    build(v&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, mid+<span class="number">1</span>, t);</div><div class="line">    updata(v);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">modify</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> s, <span class="keyword">int</span> t, <span class="keyword">int</span> pos, ll x)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (s == t) &#123;</div><div class="line">        tree[v] = x;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> mid = s+t&gt;&gt;<span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (pos &lt;= mid) &#123;</div><div class="line">        modify(v&lt;&lt;<span class="number">1</span>, s, mid, pos, x);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        modify(v&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, mid+<span class="number">1</span>, t, pos, x);</div><div class="line">    &#125;</div><div class="line">    updata(v);</div><div class="line">&#125;</div><div class="line"><span class="function">ll <span class="title">query</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> s, <span class="keyword">int</span> t, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (s &gt;= l &amp;&amp; t &lt;= r) &#123;</div><div class="line">        <span class="keyword">return</span> tree[v];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> mid = s+t&gt;&gt;<span class="number">1</span>;</div><div class="line">    ll ret = -INF;</div><div class="line">    <span class="keyword">if</span> (l &lt;= mid) &#123;</div><div class="line">        ret = max(ret, query(v&lt;&lt;<span class="number">1</span>, s, mid, l, r));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (r &gt;= mid+<span class="number">1</span>) &#123;</div><div class="line">        ret = max(ret, query(v&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, mid+<span class="number">1</span>, t, l, r));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    ll x, prev = <span class="number">0</span>, mod;</div><div class="line">    <span class="keyword">char</span> opt;</div><div class="line">    <span class="keyword">int</span> l;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d%lld"</span>, &amp;n, &amp;mod);</div><div class="line">    build(<span class="number">1</span>, <span class="number">1</span>, n);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">        <span class="built_in">cin</span> &gt;&gt; opt;</div><div class="line">        <span class="keyword">if</span> (opt == <span class="string">'A'</span>) &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;x);</div><div class="line">            modify(<span class="number">1</span>, <span class="number">1</span>, n, ++len, (x%mod+prev)%mod);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;l);</div><div class="line">            prev = query(<span class="number">1</span>, <span class="number">1</span>, n, len-l+<span class="number">1</span>, len);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, prev);</div><div class="line">            prev %= mod;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BZOJ/">BZOJ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/省选/">省选</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/线段树/">线段树</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-POJ1201 Intervals 差分约束系统" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/POJ1201 Intervals 差分约束系统/" class="article-date">
  	<time datetime="2017-08-14T16:00:00.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/POJ1201 Intervals 差分约束系统/">
        POJ1201 Intervals &lt;差分约束系统&gt;
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Intervals</p>
<p>You are given n closed, integer intervals [ai, bi] and n integers c1, …, cn.<br>Write a program that:<br>reads the number of intervals, their end points and integers c1, …, cn from the standard input, computes the minimal size of a set Z of integers which has at least ci common elements with interval [ai, bi], for each i=1,2,…,n, writes the answer to the standard output. </p>
<p>Input<br>The first line of the input contains an integer n (1 &lt;= n &lt;= 50000) – the number of intervals. The following n lines describe the intervals. The (i+1)-th line of the input contains three integers ai, bi and ci separated by single spaces and such that 0 &lt;= ai &lt;= bi &lt;= 50000 and 1 &lt;= ci &lt;= bi - ai+1.<br>Output<br>The output contains exactly one integer equal to the minimal size of set Z sharing at least ci elements with interval [ai, bi], for each i=1,2,…,n. </p>
<p>Sample Input<br>5<br>3 7 3<br>8 10 3<br>6 8 1<br>1 3 1<br>10 11 1<br>Sample Output<br>6</p>
</blockquote>
<p>标签：差分约束系统</p>
<p>题目大意：给出n个区间，试确定一个集合使得对于i=1..n，第i个区间内至少有ci个数，并使得此集合尽量小，输出最小大小。</p>
<p>题解：<br>首先用前缀和。sum[i]表示从1到i中共选出多少个数到集合中。这样对于集合[ai,bi]，有sum[bi]-sum[ai-1]&gt;=ci，于是我们可以从点ai-1到bi连一条权值为ci的边。因为题意是要满足所有的边，所以我们需要找最长路。<br>此题有一些细节问题。首先，找最长路需要起点和终点，我们需要找到这些集合覆盖的范围，即找到左端点（其实应该是左端点-1）的最小值s和右端点的最大值t，找s到t的最大值。此外，光有上述的那些边时无法构成一个连通图的，所以我们需要找一些隐含条件。可以发现有sum[i]-sum[i-1]&gt;=0，sum[i]-sum[i-1]&lt;=1，为了保持一致，应将后面的式子转化为大于等于，即sum[i-1]-sum[i]&gt;=-1，这样对于i=s+1~t，从i-1到i连接一条权值为0的路，从i到i-1连接一条权值为-1的路，之后就可以直接用SPFA找最长路了。</p>
<p>最后附上AC代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_N 50000</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">int</span> n, cnt, s, t, pre[MAX_N+<span class="number">5</span>], dis[MAX_N+<span class="number">5</span>];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span><span class="keyword">int</span> v, c, nxt;&#125; E[MAX_N*<span class="number">3</span>+<span class="number">5</span>];</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> v, <span class="keyword">int</span> c)</span> </span>&#123;</div><div class="line">	E[++cnt].v = v, E[cnt].c = c;</div><div class="line">	E[cnt].nxt = pre[u], pre[u] = cnt;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">SPFA</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="built_in">queue</span> &lt;<span class="keyword">int</span>&gt; que;</div><div class="line">	<span class="keyword">bool</span> inque[MAX_N+<span class="number">5</span>];</div><div class="line">	<span class="built_in">memset</span>(dis, <span class="number">128</span>, <span class="keyword">sizeof</span>(dis));</div><div class="line">	<span class="built_in">memset</span>(inque, <span class="number">0</span>, <span class="keyword">sizeof</span>(inque));</div><div class="line">	dis[s] = <span class="number">0</span>;</div><div class="line">	que.push(s), inque[s] = <span class="literal">true</span>;</div><div class="line">	<span class="keyword">while</span> (!que.empty()) &#123;</div><div class="line">		<span class="keyword">int</span> u = que.front();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = pre[u]; i; i = E[i].nxt) &#123;</div><div class="line">			<span class="keyword">int</span> v = E[i].v, c = E[i].c;</div><div class="line">			<span class="keyword">if</span> (dis[u]+c &gt; dis[v]) &#123;</div><div class="line">				dis[v] = dis[u]+c;</div><div class="line">				<span class="keyword">if</span> (!inque[v])	que.push(v), inque[v] = <span class="literal">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		que.pop(), inque[u] = <span class="literal">false</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n) != EOF) &#123;</div><div class="line">		cnt = <span class="number">0</span>, s = <span class="number">50000</span>, t = <span class="number">0</span>;</div><div class="line">		<span class="built_in">memset</span>(pre, <span class="number">0</span>, <span class="keyword">sizeof</span>(pre));</div><div class="line">		<span class="built_in">memset</span>(E, <span class="number">0</span>, <span class="keyword">sizeof</span>(E));</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">			<span class="keyword">int</span> u, v, c;</div><div class="line">			<span class="built_in">scanf</span>(<span class="string">"%d%d%d"</span>, &amp;u, &amp;v, &amp;c);</div><div class="line">			insert(u, v+<span class="number">1</span>, c);</div><div class="line">			s = min(s, u);</div><div class="line">			t = max(t, v+<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = s; i &lt; t; i++)	insert(i, i+<span class="number">1</span>, <span class="number">0</span>), insert(i+<span class="number">1</span>, i, <span class="number">-1</span>);</div><div class="line">		SPFA();</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, dis[t]);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/POJ/">POJ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/差分约束系统/">差分约束系统</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-BZOJ2434【NOI2011】阿狸的打字机 AC自动机+Fail树+树状数组" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/BZOJ2434【NOI2011】阿狸的打字机 AC自动机+Fail树+树状数组/" class="article-date">
  	<time datetime="2017-08-14T16:00:00.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/BZOJ2434【NOI2011】阿狸的打字机 AC自动机+Fail树+树状数组/">
        BZOJ2434【NOI2011】阿狸的打字机 &lt;AC自动机+Fail树+树状数组&gt;
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>BZOJ2434 阿狸的打字机</p>
<p>阿狸喜欢收藏各种稀奇古怪的东西，最近他淘到一台老式的打字机。打字机上只有28个按键，分别印有26个小写英文字母和’B’、’P’两个字母。<br>经阿狸研究发现，这个打字机是这样工作的：<br>·输入小写字母，打字机的一个凹槽中会加入这个字母(这个字母加在凹槽的最后)。<br>·按一下印有’B’的按键，打字机凹槽中最后一个字母会消失。<br>·按一下印有’P’的按键，打字机会在纸上打印出凹槽中现有的所有字母并换行，但凹槽中的字母不会消失。<br>例如，阿狸输入aPaPBbP，纸上被打印的字符如下：<br>a<br>aa<br>ab<br>我们把纸上打印出来的字符串从1开始顺序编号，一直到n。打字机有一个非常有趣的功能，在打字机中暗藏一个带数字的小键盘，在小键盘上输入两个数(x,y)（其中1≤x,y≤n），打字机会显示第x个打印的字符串在第y个打印的字符串中出现了多少次。<br>阿狸发现了这个功能以后很兴奋，他想写个程序完成同样的功能，你能帮助他么？</p>
<p>Input<br>输入的第一行包含一个字符串，按阿狸的输入顺序给出所有阿狸输入的字符。<br>第二行包含一个整数m，表示询问个数。<br>接下来m行描述所有由小键盘输入的询问。其中第i行包含两个整数x, y，表示第i个询问为(x, y)。<br>Output<br>输出m行，其中第i行包含一个整数，表示第i个询问的答案。</p>
<p>Sample Input<br>aPaPBbP<br>3<br>1 2<br>1 3<br>2 3<br>Sample Output<br>2<br>1<br>0</p>
<p>Hint<br>1&lt;=N&lt;=10^5<br>1&lt;=M&lt;=10^5<br>输入总长&lt;=10^5</p>
</blockquote>
<p>标签：AC自动机 Fail树 树状数组</p>
<p>这道题的提示还是很明显的。<br>读完题目，很容易发现此题打字的部分就是在建一棵Trie树。<br>输入小写字母即在Trie中添加一个子结点并向儿子结点走，输入‘B’即退回到父结点，输入’P‘即在当前结点打标记。<br>因而我们可以构建Trie树如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//我写Trie树的习惯：把根节点定为1</span></div><div class="line">	cnt = <span class="number">0</span>, root = <span class="number">1</span>, fa[root] = <span class="number">0</span>;</div><div class="line">	<span class="comment">//0号节点所有儿子都练到根，这样AC自动机CalcFail时更方便</span></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++)	trie[<span class="number">0</span>][i] = root;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">	init();</div><div class="line">	n = <span class="built_in">strlen</span>(s);</div><div class="line">	ind = <span class="number">1</span>;<span class="comment">//ind记录当前结点数</span></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, cur = root; i &lt; n; i++) &#123;</div><div class="line">		<span class="keyword">if</span> (s[i] == <span class="string">'B'</span>) &#123;</div><div class="line">			<span class="comment">//退到父结点</span></div><div class="line">			cur = fa[cur];</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (s[i] == <span class="string">'P'</span>) &#123;</div><div class="line">			<span class="comment">//打标记，标记为第cnt个字符串</span></div><div class="line">			pos[++cnt] = cur;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">//新建子结点</span></div><div class="line">			trie[cur][s[i]-<span class="string">'a'</span>] = ++ind;</div><div class="line">			fa[ind] =cur, cur = ind;`</div><div class="line">		&#125;。</div><div class="line">。</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来我们对付这题的询问。<br>首先，它要求一个字符串在另一个字符串中出现多少次，这显然是AC自动机的操作，所以我们建立fail数组如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CalcFail</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="built_in">queue</span> &lt;<span class="keyword">int</span>&gt; que;</div><div class="line">	que.push(root);</div><div class="line">	<span class="keyword">while</span> (!que.empty()) &#123;</div><div class="line">		<span class="keyword">int</span> u = que.front();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; DICNUM; i++) &#123;</div><div class="line">			<span class="keyword">if</span> (trie[u][i]) &#123;</div><div class="line">				fail[trie[u][i]] = trie[fail[u]][i];</div><div class="line">				que.push(trie[u][i]);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				trie[u][i] = trie[fail[u]][i];</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		que.pop();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们考虑fail数组的实质。如果A结点的fail指向B结点，则B结点代表的字符串一定是A结点代表字符串的后缀，即经过A的所有路径组成的字符串都包含B结点代表的字符串。对于一个字符串，它的所有字串为它所有前缀的所有后缀，所以对于询问(x,y)，我们需要找出从根节点到y的路径中有多少结点可以通过fail指针转移到x。<br>这时我们就需要考虑Fail树了。对于任意结点p，我们把所有通过fail指针能<strong>直接</strong>转移到p的结点作为p的子结点，而p通过fail指针转移到的结点作为p的父结点。这样我们就能构建一棵树。这样一来，对于询问(x,y)，问题等价于从根到y的结点中有多少节点是在x的子树中。我们就可以用DFS序操作。然后用树状数组维护（线段树太麻烦）。<br>为了使询问变得更好操作，我们考虑把询问按y值排序，这样我们就只需一直往下走，然后标记经过的结点，然后统计x子树即可。</p>
<p>最后附上AC代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_N 100000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> DICNUM 26</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">int</span> n, m, cnt, ind;</div><div class="line"><span class="keyword">int</span> root, trie[MAX_N+<span class="number">5</span>][DICNUM], fa[MAX_N+<span class="number">5</span>], fail[MAX_N+<span class="number">5</span>], pos[MAX_N+<span class="number">5</span>], ans[MAX_N+<span class="number">5</span>];</div><div class="line"><span class="keyword">char</span> s[MAX_N+<span class="number">5</span>];</div><div class="line"><span class="built_in">vector</span> &lt;<span class="keyword">int</span>&gt; G[MAX_N+<span class="number">5</span>];</div><div class="line"><span class="keyword">int</span> into[MAX_N+<span class="number">5</span>], outo[MAX_N+<span class="number">5</span>];</div><div class="line"><span class="keyword">int</span> tr[MAX_N+<span class="number">5</span>];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Query</span> &#123;</span><span class="keyword">int</span> x, y, id;&#125; q[MAX_N+<span class="number">5</span>];</div><div class="line"><span class="function"><span class="keyword">bool</span> <span class="title">cmp</span> <span class="params">(<span class="keyword">const</span> Query &amp;a, <span class="keyword">const</span> Query &amp;b)</span> </span>&#123;<span class="keyword">return</span> a.y &lt; b.y;&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">	cnt = <span class="number">0</span>, root = <span class="number">1</span>, fa[root] = <span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; DICNUM; i++)	trie[<span class="number">0</span>][i] = root;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">CalcFail</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="built_in">queue</span> &lt;<span class="keyword">int</span>&gt; que;</div><div class="line">	que.push(root);</div><div class="line">	<span class="keyword">while</span> (!que.empty()) &#123;</div><div class="line">		<span class="keyword">int</span> u = que.front();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; DICNUM; i++) &#123;</div><div class="line">			<span class="keyword">if</span> (trie[u][i]) &#123;</div><div class="line">				fail[trie[u][i]] = trie[fail[u]][i];</div><div class="line">				que.push(trie[u][i]);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				trie[u][i] = trie[fail[u]][i];</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		que.pop();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">DFS</span><span class="params">(<span class="keyword">int</span> u)</span> </span>&#123;</div><div class="line">	into[u] = ++ind;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; G[u].size(); i++)	DFS(G[u][i]);</div><div class="line">	outo[u] = ind;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">	init();</div><div class="line">	n = <span class="built_in">strlen</span>(s);	ind = <span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, cur = root; i &lt; n; i++) &#123;</div><div class="line">		<span class="keyword">if</span> (s[i] == <span class="string">'B'</span>) &#123;</div><div class="line">			cur = fa[cur];</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (s[i] == <span class="string">'P'</span>) &#123;</div><div class="line">			pos[++cnt] = cur;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			trie[cur][s[i]-<span class="string">'a'</span>] = ++ind;</div><div class="line">			fa[ind] = cur, cur = ind;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	CalcFail();</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= ind; i++)	G[fail[i]].push_back(i);</div><div class="line">	ind = <span class="number">0</span>;</div><div class="line">	DFS(root);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">inc</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;<span class="keyword">for</span> (; pos &lt;= ind; pos += pos&amp;(-pos))	tr[pos]++;&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dec</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;<span class="keyword">for</span> (; pos &lt;= ind; pos += pos&amp;(-pos))	tr[pos]--;&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;<span class="keyword">int</span> ret = <span class="number">0</span>; <span class="keyword">for</span> (; pos; pos -= pos&amp;(-pos))	ret += tr[pos]; <span class="keyword">return</span> ret;&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">()</span> </span>&#123;</div><div class="line">	sort(q, q+m, cmp);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, cur = root, now = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">		<span class="keyword">if</span> (s[i] == <span class="string">'B'</span>) &#123;</div><div class="line">			dec(into[cur]);</div><div class="line">			cur = fa[cur];</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (s[i] == <span class="string">'P'</span>) &#123;</div><div class="line">			now++;</div><div class="line">			<span class="keyword">for</span> (; j &lt; m &amp;&amp; q[j].y == now; j++)</div><div class="line">				ans[q[j].id] = sum(outo[pos[q[j].x]])-sum(into[pos[q[j].x]]<span class="number">-1</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			cur = trie[cur][s[i]-<span class="string">'a'</span>];</div><div class="line">			inc(into[cur]);</div><div class="line">		&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%s"</span>, s);</div><div class="line">	build();</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;m);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)	<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;q[i].x, &amp;q[i].y), q[i].id = i;</div><div class="line">	solve();</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)	<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ans[i]);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AC自动机/">AC自动机</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BZOJ/">BZOJ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NOI/">NOI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/树状数组/">树状数组</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-主席树原理与基础例题" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/主席树原理与基础例题/" class="article-date">
  	<time datetime="2017-07-24T16:00:00.000Z" itemprop="datePublished">2017-07-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/主席树原理与基础例题/">
        主席树原理与基础例题
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>声明：因可持久化线段树的图片不好找，故转载使用JK金坤的图片辅助说明，各位读者有兴趣可以去看JK金坤的求区间第K小的题解，也讲的很清楚。</p>
<p>可持久化线段树，看到名字，就知道一定和线段树相关，在此，对于线段树的原理就不再赘述，读者若不懂可自行百度。可持久化，就是让一个数据结构做到能够访问任何一个历史状态。总体说来，让线段树持久化并不算太复杂。接下来，让我们从一道例题入手。</p>
<blockquote>
<p>【OpenJudge1001】Challenge 1<br>总时间限制: 10000ms<br>单个测试点时间限制: 1000ms<br>内存限制: 262144kB</p>
<p>描述 给一个长为N的数列，有M次操作，每次操作是以下两种之一： （1）修改数列中的一个数 （2）求数列中某位置在某次操作后的值</p>
<p>输入 第一行两个正整数N和M。 第二行N个整数表示这个数列。<br>接下来M行，每行开头是一个字符，若该字符为’M’，则表示一个修改操作，接下来两个整数x和y，表示把x位置的值修改为y；若该字符为’Q’，则表示一个询问操作，接下来两个整数x和y，表示求x位置在第y次操作后的值。<br>输出 对每一个询问操作单独输出一行，表示答案。</p>
<p>样例输入<br>5 3<br>1 2 3 4 5<br>Q 1 0<br>M 1 3<br>Q 1 2<br>样例输出<br>1<br>3<br>提示<br>1&lt;=N&lt;=1e5，1&lt;=M&lt;=1e5，输入保证合法，且所有整数可用带符号32位整型存储。</p>
</blockquote>
<p> 这道题很水，操作很简单，单点修改，历史单点查询，甚至连区间都涉及不到。各位读者可能马上想到可以离线操作，先把所有操作读入，在按时间从前往后操作，每次操作后看是否有询问在此时进行，记录答案，最后按询问顺序输出。这样做无疑是能A掉这道简单题的，但如果我们要在线做呢？</p>
<p>1.记录历史版本<br>在线做的话，各位读者可能会首先想到，对于每次修改，把修改前后的列都存下来，并标记是哪次操作后的数列，询问的时候按时间查询即可。但这时就出现了一个问题：题目中原数列最长有1e5个数，1e5次询问，如果前1e5-1次询问都是更改某个数，最后一次才是询问某位置的数在t时间的值，那我们需要存储1e5*1e5个数，肯定会爆空间。<br>到这里，各位聪明的读者一定又想到了一个方法：每次只记录更改的值，不记录不变的数值，这样可以少消耗大量空间。为了快速实现这一过程，避免麻烦，我们想到了一个数列操作的方便数据结构，线段树。</p>
<p>2.部分修改的线段树<br>对于每次修改，我们都只会存储修改的值，而对于一颗线段树来说，我们则存储从这个叶子结点到树根的这条链上的节点。<br>如果我们要修改第4个数，即修改[4,4]，我们只会新建三个节点：[4,4][3,4][1,4]，并把这些节点的子节点中没有修改的节点指向原来对应的子节点，即[1,4]指向原树中的[1,2]和新建的[3,4]，[3,4]指向原树中的[3,3]和新建的[4,4]。<br>这样一来，对于每次修改，我们只用新建logn个节点，空间够了。</p>
<p>3.函数式线段树<br>我们解决了空间的问题，但这个时候，我们又有了一个细节上的问题：新建节点的编号怎么定？肯定不能像以前写普通的堆式线段树一样，左儿子编号是节点编号乘二，右儿子编号是节点编号乘二加一。这里我们只添加一条链，不能那样编号。如果有写过字典树或AC自动机的读者，可以类比得出这里需要函数式建树，即记录一个当前的总节点数cnt，每增加一个节点，这个新节点的编号为cnt+1，随后cnt++。<br>除此之外，我们可以知道，第t时刻的数列，对应到线段树中就是以第t个树根为树根的那颗线段树，因而我们需要记录每个时刻对应线段树的根，即root[]。</p>
<p>接下来给出代码实现：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_N 100000</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span><span class="keyword">int</span> ls, rs, val;&#125; tr[<span class="number">2000000</span>];	<span class="comment">//每个节点三个值，ls为左儿子编号，rs为右儿子编号，val为该节点权值</span></div><div class="line"><span class="keyword">int</span> n, m, cnt, now;</div><div class="line"><span class="keyword">int</span> root[MAX_N+<span class="number">5</span>];	<span class="comment">//root数组记录每个时刻对应那颗线段树的树根</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> s, <span class="keyword">int</span> t)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (s == t) &#123;</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;tr[v].val);</div><div class="line">		<span class="comment">//若已到叶子结点，则读入</span></div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	tr[v].ls = ++cnt;	<span class="comment">//新建左儿子，编号为节点总数+1</span></div><div class="line">	tr[v].rs = ++cnt;	<span class="comment">//新建右儿子，编号为节点总数+1</span></div><div class="line">	<span class="keyword">int</span> mid = s+t&gt;&gt;<span class="number">1</span>;</div><div class="line">	<span class="comment">//递归新建两个子区间</span></div><div class="line">	build(tr[v].ls, s, mid);</div><div class="line">	build(tr[v].rs, mid+<span class="number">1</span>, t);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">modify</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> s, <span class="keyword">int</span> t, <span class="keyword">int</span> ori, <span class="keyword">int</span> pos, <span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">	<span class="comment">//ori为原树上v节点对应的原节点</span></div><div class="line">	tr[v] = tr[ori];	</div><div class="line">	<span class="comment">//先将ori的各项成员参数赋给v，因为我们会选ori左右儿子中的一个进行修改和新建，它的另外一个儿子会保留</span></div><div class="line">	<span class="keyword">if</span> (s == t) &#123;</div><div class="line">		tr[v].val = x;</div><div class="line">		<span class="comment">//若已到叶子结点，则修改并返回</span></div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> mid = s+t&gt;&gt;<span class="number">1</span>;</div><div class="line">	<span class="keyword">if</span> (pos &lt;= mid) &#123;</div><div class="line">		<span class="comment">//若pos在左区间，我们要修改左儿子，在这里即新建一个左儿子，和建树一样，要++cnt</span></div><div class="line">		tr[v].ls = ++cnt;</div><div class="line">		modify(tr[v].ls, s, mid, tr[ori].ls, pos, x);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">//原理同上</span></div><div class="line">		tr[v].rs = ++cnt;</div><div class="line">		modify(tr[v].rs, mid+<span class="number">1</span>, t, tr[ori].rs, pos, x);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//注：上面递归modify修改时，传参数要小心，对于ori这项参数，左子节点的原节点是tr[ori].ls，不该直接传ori，右边同理</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> s, <span class="keyword">int</span> t, <span class="keyword">int</span> pos)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (s == t)	<span class="keyword">return</span> tr[v].val;</div><div class="line">	<span class="keyword">int</span> mid = s+t&gt;&gt;<span class="number">1</span>;</div><div class="line">	<span class="keyword">if</span> (pos &lt;= mid) <span class="keyword">return</span> query(tr[v].ls, s, mid, pos);</div><div class="line">	<span class="keyword">else</span>	<span class="keyword">return</span> query(tr[v].rs, mid+<span class="number">1</span>, t, pos);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;n, &amp;m);</div><div class="line">	now = <span class="number">0</span>, cnt = <span class="number">0</span>;</div><div class="line">	root[now] = ++cnt;	<span class="comment">//原树根为1</span></div><div class="line">	build(root[now], <span class="number">1</span>, n);</div><div class="line">	<span class="keyword">while</span> (m--) &#123;</div><div class="line">		<span class="keyword">char</span> ch;	<span class="keyword">int</span> a, b;</div><div class="line">		<span class="built_in">cin</span> &gt;&gt; ch &gt;&gt; a &gt;&gt; b;</div><div class="line">		<span class="keyword">if</span> (ch == <span class="string">'Q'</span>) &#123;</div><div class="line">			now++;	<span class="comment">//时间戳++</span></div><div class="line">			root[now] = root[now<span class="number">-1</span>];	<span class="comment">//树根没变，所以用上一个树根</span></div><div class="line">			<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, query(root[b], <span class="number">1</span>, n, a));</div><div class="line">			<span class="comment">//从root[b]，即b时刻的树根开始query</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (ch == <span class="string">'M'</span>) &#123;</div><div class="line">			now++;	<span class="comment">//时间戳++</span></div><div class="line">			root[now] = ++cnt;	<span class="comment">//新建一个树根，并从它开始修改</span></div><div class="line">			modify(root[now], <span class="number">1</span>, n, root[now<span class="number">-1</span>], a, b);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>各位读者应该看懂了吧，接下来，我们再来做一道简单题练手</p>
<blockquote>
<p>【OpenJudge1002】Challenge 2 总时间限制: 10000ms 单个测试点时间限制: 1000ms 内存限制:<br>262144kB</p>
<p>描述 给一个空数列，有M次操作，每次操作是以下三种之一： （1）在数列后加一个数 （2）求数列中某位置的值<br>（3）撤销掉最后进行的若干次操作（1和3）</p>
<p>输入 第一行一个正整数M。<br>接下来M行，每行开头是一个字符，若该字符为’A’，则表示一个加数操作，接下来一个整数x，表示在数列后加一个整数x；若该字符为’Q’，则表示一个询问操作，接下来一个整数x，表示求x位置的值；若该字符为’U’，则表示一个撤销操作，接下来一个整数x，表示撤销掉最后进行的若干次操作。<br>输出 对每一个询问操作单独输出一行，表示答案。</p>
<p>样例输入<br>9<br>A 1<br>A 2<br>A 3<br>Q 3<br>U 1<br>A 4<br>Q 3<br>U 2<br>Q 3<br>样例输出<br>3<br>4<br>3</p>
<p>提示 1&lt;=M&lt;=10^5，输入保证合法，且所有整数可用带符号32位整型存储。</p>
</blockquote>
<p>读者请先自己想想，再继续看。<br>因为本题和上题差不多，很简单，所以不再赘述，各位读者可直接看代码</p>
<p>代码如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_N 100000</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span><span class="keyword">int</span> ls, rs, val;&#125; tr[<span class="number">2000000</span>+<span class="number">5</span>];</div><div class="line"><span class="keyword">int</span> n, cnt, now;</div><div class="line"><span class="keyword">int</span> num[MAX_N+<span class="number">5</span>], root[MAX_N+<span class="number">5</span>];	<span class="comment">//num数组用于存储每个时刻数列的长度，以便知道该从哪里修改</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (l == r)	<span class="keyword">return</span>;</div><div class="line">	<span class="keyword">int</span> mid = l+r&gt;&gt;<span class="number">1</span>;</div><div class="line">	tr[v].ls = ++cnt;</div><div class="line">	tr[v].rs = ++cnt;</div><div class="line">	build(tr[v].ls, l, mid);</div><div class="line">	build(tr[v].rs, mid+<span class="number">1</span>, r);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">modify</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> ori, <span class="keyword">int</span> pos, <span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">	tr[v] = tr[ori];</div><div class="line">	<span class="keyword">if</span> (l == r) &#123;</div><div class="line">		tr[v].val = x;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> mid = l+r&gt;&gt;<span class="number">1</span>;</div><div class="line">	<span class="keyword">if</span> (pos &lt;= mid) &#123;</div><div class="line">		tr[v].ls = ++cnt;</div><div class="line">		modify(tr[v].ls, l, mid, tr[ori].ls, pos, x);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		tr[v].rs = ++cnt;</div><div class="line">		modify(tr[v].rs, mid+<span class="number">1</span>, r, tr[ori].rs, pos, x);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> pos)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (l == r)	<span class="keyword">return</span> tr[v].val;</div><div class="line">	<span class="keyword">int</span> mid = l+r&gt;&gt;<span class="number">1</span>;</div><div class="line">	<span class="keyword">if</span> (pos &lt;= mid)	<span class="keyword">return</span> query(tr[v].ls, l, mid, pos);</div><div class="line">	<span class="keyword">else</span>	<span class="keyword">return</span> query(tr[v].rs, mid+<span class="number">1</span>, r, pos);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n);</div><div class="line">	now = <span class="number">0</span>;</div><div class="line">	num[now] = <span class="number">0</span>;</div><div class="line">	root[now] = ++cnt;</div><div class="line">	build(root[now], <span class="number">1</span>, n);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">		<span class="keyword">char</span> ch;	<span class="keyword">int</span> x;</div><div class="line">		<span class="built_in">cin</span> &gt;&gt; ch &gt;&gt; x;</div><div class="line">		<span class="keyword">if</span> (ch == <span class="string">'A'</span>) &#123;</div><div class="line">			now++;</div><div class="line">			num[now] = num[now<span class="number">-1</span>]+<span class="number">1</span>;</div><div class="line">			root[now] = ++cnt;</div><div class="line">			modify(root[now], <span class="number">1</span>, n, root[now<span class="number">-1</span>], num[now], x);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (ch == <span class="string">'Q'</span>) &#123;</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, query(root[now], <span class="number">1</span>, n, x));</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (ch == <span class="string">'U'</span>) &#123;</div><div class="line">			now++;</div><div class="line">			num[now] = num[now<span class="number">-1</span>-x];</div><div class="line">			root[now] = root[now<span class="number">-1</span>-x];</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面是最最基础的可持久化线段树，接下来我们来看一个基础的应用：区间第k小</p>
<blockquote>
<p>【POJ2104】K-th Number Time Limit: 20000MS        Memory Limit: 65536K</p>
<p>Description You are working for Macrohard company in data structures<br>department. After failing your previous task about key insertion you<br>were asked to write a new data structure that would be able to return<br>quickly k-th order statistics in the array segment.  That is, given an<br>array a[1…n] of different integer numbers, your program must answer<br>a series of questions Q(i, j, k) in the form: “What would be the k-th<br>number in a[i…j] segment, if this segment was sorted?”  For example,<br>consider the array a = (1, 5, 2, 6, 3, 7, 4). Let the question be Q(2,<br>5, 3). The segment a[2…5] is (5, 2, 6, 3). If we sort this segment,<br>we get (2, 3, 5, 6), the third number is 5, and therefore the answer<br>to the question is 5.</p>
<p>Input The first line of the input file contains n — the size of the<br>array, and m — the number of questions to answer (1 &lt;= n &lt;= 100 000,<br>1 &lt;= m &lt;= 5 000).  The second line contains n different integer<br>numbers not exceeding 109 by their absolute values — the array for<br>which the answers should be given.  The following m lines contain<br>question descriptions, each description consists of three numbers: i,<br>j, and k (1 &lt;= i &lt;= j &lt;= n, 1 &lt;= k &lt;= j - i + 1) and represents the<br>question Q(i, j, k). Output For each question output the answer to it<br>— the k-th number in sorted a[i…j] segment.</p>
<p>Sample Input<br>7 3<br>1 5 2 6 3 7 4<br>2 5 3<br>4 4 1<br>1 7 3<br>Sample Output<br>5<br>6<br>3</p>
</blockquote>
<p>题目大意：给出一个长度为n的序列，针对每次询问，读入a，b，k，求第a个数到第b个数中第k小的数</p>
<p>同样，请各位读者先自行思考，再继续阅读</p>
<p>题解：<br>1.值域线段树<br>这道题既然和线段树有关系，肯定先得把这个数列存到线段树里。但我们注意到，我们需要求的是第k小，所以我们不能用普通线段树，而应该是能体现出数与数之间大小关系的线段树，于是我们不难想到值域线段树。节点v的范围是[l,r]，则存储数列在[l,r]范围内的数的个数。找第k小的时候，对于节点v，左右儿子范围分别是[l,mid]和[mid+1,r]，若v.ls.size&lt;=k，则第k小在[l,mid]范围内，所以递归询问左子节点，右边同理，只是询问的是右子节点中的第k-v.ls.size小，注意不再是第k小。</p>
<p>2.离散化<br>想到了值域线段树，则要注意值域的问题，我们看到题目中值域为int32，直接存肯定爆空间，所以我们需要离散化，即给每个数排序后用序号代替每个数。这样大小关系没有变化，而值域变成1e5了<br>离散化代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;n, &amp;m);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;pre[i].val), pre[i].id = i;</div><div class="line">sort(pre+<span class="number">1</span>, pre+n+<span class="number">1</span>, cmp);</div><div class="line">tot = <span class="number">0</span>;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">	<span class="keyword">if</span> (pre[i].val != pre[i<span class="number">-1</span>].val) &#123;</div><div class="line">		hash[++tot] = pre[i].val;	<span class="comment">//hash[p]存储序号p代替的是哪个数</span></div><div class="line">	&#125;</div><div class="line">	num[pre[i].id] = tot;	<span class="comment">//num[p]存储原来的第p个数被代替为什么数</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3.前缀和思想</p>
<p>现在我们的难题是：如何把全局第k小变为区间第k小。<br>这里，我们需要用到前缀和的思想。我们分别存储第1-i个数中范围在[l,r]的数的个数和第1-j个数中范围在[l,r]的数的个数，这样我们若需要第i+1到第j个数中[l,r]的个数，就只用sum[j][l,r]-sum[i][l,r]即可。所以，我们存n颗线段树，第p颗存储第1-p个数中的值域情况。<br>例如：对于序列7，2，3，5，1，4，3，第4颗树的[2,4]节点存储都是从第一个数到第四个数中值在[2,4]中的数的个数。7，2，3，5中在[2,4]的数为2和3，故此节点的值为2。</p>
<p>4.可持久化线段树<br>有了以上思路，剩下的问题就是如何把这n颗线段树存进去。直接存一定会爆空间，而注意到每次加一个数后，不是所有节点都发生了改变，因而我们只需要存储有改动的节点，可以使用可持久化线段树。和上面的题一样，我们把新建的节点指回原来的子节点，可以参照前面的说明。</p>
<p>AC代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_N 100000</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span><span class="keyword">int</span> ls, rs, val;&#125; tr[MAX_N*<span class="number">20</span>+<span class="number">5</span>];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">p</span> &#123;</span><span class="keyword">int</span> val, id;&#125; pre[MAX_N+<span class="number">5</span>];</div><div class="line"><span class="function"><span class="keyword">bool</span> <span class="title">cmp</span><span class="params">(<span class="keyword">const</span> p &amp;a, <span class="keyword">const</span> p &amp;b)</span> </span>&#123;<span class="keyword">return</span> a.val &lt; b.val;&#125;</div><div class="line"><span class="keyword">int</span> n, m;</div><div class="line"><span class="keyword">int</span> num[MAX_N+<span class="number">5</span>], hash[MAX_N+<span class="number">5</span>], tot;</div><div class="line"><span class="keyword">int</span> cnt, root[MAX_N+<span class="number">5</span>];</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">updata</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;tr[v].val = tr[tr[v].ls].val+tr[tr[v].rs].val;&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> s, <span class="keyword">int</span> t)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (s == t)	<span class="keyword">return</span>;</div><div class="line">	tr[v].ls = ++cnt;</div><div class="line">	tr[v].rs = ++cnt;</div><div class="line">	<span class="keyword">int</span> mid = s+t&gt;&gt;<span class="number">1</span>;</div><div class="line">	build(tr[v].ls, s, mid);</div><div class="line">	build(tr[v].rs, mid+<span class="number">1</span>, t);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">modify</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> s, <span class="keyword">int</span> t, <span class="keyword">int</span> ori, <span class="keyword">int</span> pos, <span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">	tr[v] = tr[ori];</div><div class="line">	<span class="keyword">if</span> (s == t) &#123;</div><div class="line">		tr[v].val += x;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> mid = s+t&gt;&gt;<span class="number">1</span>;</div><div class="line">	<span class="keyword">if</span> (pos &lt;= mid) &#123;</div><div class="line">		tr[v].ls = ++cnt;</div><div class="line">		modify(tr[v].ls, s, mid, tr[ori].ls, pos, x);</div><div class="line">	&#125; <span class="keyword">else</span>&#123;</div><div class="line">		tr[v].rs = ++cnt;</div><div class="line">		modify(tr[v].rs, mid+<span class="number">1</span>, t, tr[ori].rs, pos, x);</div><div class="line">	&#125;</div><div class="line">	updata(v);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> v1, <span class="keyword">int</span> v2, <span class="keyword">int</span> s, <span class="keyword">int</span> t, <span class="keyword">int</span> k)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (s == t)	<span class="keyword">return</span> s;</div><div class="line">	<span class="keyword">int</span> mid = s+t&gt;&gt;<span class="number">1</span>, tmp = tr[tr[v2].ls].val-tr[tr[v1].ls].val;</div><div class="line">	<span class="keyword">if</span> (tmp &gt;= k)	<span class="keyword">return</span> query(tr[v1].ls, tr[v2].ls, s, mid, k);</div><div class="line">	<span class="keyword">else</span>	<span class="keyword">return</span> query(tr[v1].rs, tr[v2].rs, mid+<span class="number">1</span>, t, k-tmp);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;n, &amp;m);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;pre[i].val), pre[i].id = i;</div><div class="line">	sort(pre+<span class="number">1</span>, pre+n+<span class="number">1</span>, cmp);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">		<span class="keyword">if</span> (pre[i].val != pre[i<span class="number">-1</span>].val) &#123;</div><div class="line">			hash[++tot] = pre[i].val;</div><div class="line">		&#125;</div><div class="line">		num[pre[i].id] = tot;</div><div class="line">	&#125;</div><div class="line">	root[<span class="number">0</span>] = ++cnt;</div><div class="line">	build(root[<span class="number">0</span>], <span class="number">1</span>, n);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">		root[i] = ++cnt;</div><div class="line">		modify(root[i], <span class="number">1</span>, n, root[i<span class="number">-1</span>], num[i], <span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">while</span> (m--) &#123;</div><div class="line">		<span class="keyword">int</span> l, r, k;</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d%d%d"</span>, &amp;l, &amp;r, &amp;k);</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, hash[query(root[l<span class="number">-1</span>], root[r], <span class="number">1</span>, n, k)]);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注：本题是可持久化线段树的必写题，想学可持久化线段树的读者一定要写这道题，一定！！！</p>
<p>上面的三道题都是最为简单基础的可持久化</p>
<p>线段树题目，可持久化线段树是可以区间修改的，但是为避免新建过多节点，不能downtag，需要标记永久化，询问的时候一路累加下去就行了，情况可能稍微多一些，有意的读者请去做一道叫To The Moon的题。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/主席树/">主席树</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-AC自动机基础例题" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/AC自动机基础例题/" class="article-date">
  	<time datetime="2017-07-13T16:00:00.000Z" itemprop="datePublished">2017-07-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/AC自动机基础例题/">
        AC自动机基础例题
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>AC自动机(Aho-Corasick Automation)用于解决多模式串匹配主串的问题<br>给所有模式串写一个Trie，在Trie上跑KMP，其中KMP的next数组变成了AC自动机的Fail指针<br>计算fail和计算next一样，用dp，只不过这里是树上dp<br>原理不再赘述，上模板</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ACautomation</span> &#123;</span></div><div class="line"><span class="keyword">private</span>:</div><div class="line">	<span class="keyword">int</span> cnt, root;</div><div class="line">	<span class="keyword">int</span> **child, *sta, *fail;</div><div class="line">	<span class="keyword">bool</span> *flag;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">	ACautomation(<span class="keyword">int</span> tot) &#123;</div><div class="line">		cnt = root = <span class="number">1</span>;</div><div class="line">		sta = <span class="keyword">new</span> <span class="keyword">int</span>[tot+<span class="number">1</span>];</div><div class="line">		<span class="built_in">memset</span>(sta, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)*(tot+<span class="number">1</span>));</div><div class="line">		fail = <span class="keyword">new</span> <span class="keyword">int</span>[tot+<span class="number">1</span>];</div><div class="line">		<span class="built_in">memset</span>(fail, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)*(tot+<span class="number">1</span>));</div><div class="line">		flag = <span class="keyword">new</span> <span class="keyword">bool</span>[tot+<span class="number">1</span>];</div><div class="line">		<span class="built_in">memset</span>(flag, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">bool</span>)*(tot+<span class="number">1</span>));</div><div class="line">		child = <span class="keyword">new</span> <span class="keyword">int</span>*[tot+<span class="number">1</span>];</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= tot; i++) &#123;</div><div class="line">			child[i] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">26</span>];</div><div class="line">			<span class="built_in">memset</span>(child[i], <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)*<span class="number">26</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++)	child[<span class="number">0</span>][i] = <span class="number">1</span>;</div><div class="line">	&#125;</div><div class="line">	~ACautomation() &#123;</div><div class="line">		<span class="keyword">delete</span>[] sta;</div><div class="line">		<span class="keyword">delete</span>[] fail;</div><div class="line">		<span class="keyword">delete</span>[] flag;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= cnt; i++)</div><div class="line">			<span class="keyword">delete</span>[] child[i];</div><div class="line">		<span class="keyword">delete</span>[] child;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="built_in">string</span>&amp; s)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> cur = <span class="number">1</span>, i;</div><div class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; s.length(); cur = child[cur][s[i++]-<span class="string">'a'</span>])</div><div class="line">			<span class="keyword">if</span> (!child[cur][s[i]-<span class="string">'a'</span>])	child[cur][s[i]-<span class="string">'a'</span>] = ++cnt;</div><div class="line">		sta[cur]++;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setFail</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="built_in">queue</span> &lt;<span class="keyword">int</span>&gt; que;</div><div class="line">		que.push(<span class="number">1</span>);</div><div class="line">		<span class="keyword">while</span> (!que.empty()) &#123;</div><div class="line">			<span class="keyword">int</span> u = que.front();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) &#123;</div><div class="line">				<span class="keyword">if</span> (child[u][i]) &#123;</div><div class="line">					fail[child[u][i]] = child[fail[u]][i];</div><div class="line">					que.push(child[u][i]);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					child[u][i] = child[fail[u]][i];</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			que.pop();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="built_in">string</span>&amp; s)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> ret = <span class="number">0</span>, cur = <span class="number">1</span>, index;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.length(); i++) &#123;</div><div class="line">			flag[cur] = <span class="literal">true</span>;</div><div class="line">			index = s[i]-<span class="string">'a'</span>;</div><div class="line">			<span class="keyword">while</span> (!child[cur][index])	cur = fail[cur];</div><div class="line">			cur = child[cur][index];</div><div class="line">			<span class="keyword">if</span> (flag[cur])	<span class="keyword">continue</span>;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = cur; j; j = fail[j]) &#123;</div><div class="line">				ret += sta[j];</div><div class="line">				sta[j] = <span class="number">0</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> ret;</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> n;</div><div class="line">	<span class="built_in">cin</span> &gt;&gt; n;</div><div class="line">	<span class="function">ACautomation <span class="title">T</span><span class="params">(n*<span class="number">50</span>)</span></span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">		<span class="built_in">string</span> s;</div><div class="line">		<span class="built_in">cin</span> &gt;&gt; s;</div><div class="line">		T.insert(s);</div><div class="line">	&#125;</div><div class="line">	T.setFail();</div><div class="line">	<span class="built_in">string</span> str;</div><div class="line">	<span class="built_in">cin</span> &gt;&gt; str;</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; T.query(str);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是本人第一次写AC自动机封装的代码，很拙劣。由于我写Trie树一直把根节点设为1号，所以想出把0号节点所有儿子都指向1，这样如果fail指回到0的时候，child[u][i]都会将其重新指向根节点1，这样思考会简单一些。但是有时候要TLE</p>
<p>我做的第一道AC自动机题目是HDU2222，这是裸的模板，数据也很水</p>
<blockquote>
<p>【HDU2222】 Keywords Search<br>Time Limit: 2000/1000 MS (Java/Others)<br>Memory Limit: 131072/131072 K (Java/Others)</p>
<p>Problem Description<br>In the modern time, Search engine came into the life of everybody like Google, Baidu, etc.<br>Wiskey also wants to bring this feature to his image retrieval system.<br>Every image have a long description, when users type some keywords to find the image, the system will match the keywords with description of image and show the image which the most keywords be matched.<br>To simplify the problem, giving you a description of image, and some keywords, you should tell me how many keywords will be match.</p>
<p>Input<br>First line will contain one integer means how many cases will follow by.<br>Each case will contain two integers N means the number of keywords and N keywords follow. (N &lt;= 10000)<br>Each keyword will only contains characters ‘a’-‘z’, and the length will be not longer than 50.<br>The last line is the description, and the length will be not longer than 1000000.<br>Output<br>Print how many keywords are contained in the description.</p>
<p>Sample Input<br>1<br>5<br>she<br>he<br>say<br>shr<br>her<br>yasherhs<br>Sample Output<br>3</p>
</blockquote>
<p>AC代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_LETTER 500000</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">int</span> trie[MAX_LETTER+<span class="number">5</span>][<span class="number">26</span>], tag[MAX_LETTER+<span class="number">5</span>], cnt;</div><div class="line"><span class="keyword">int</span> fail[MAX_LETTER+<span class="number">5</span>], flag[MAX_LETTER+<span class="number">5</span>], que[MAX_LETTER+<span class="number">5</span>];</div><div class="line"><span class="keyword">char</span> s[<span class="number">55</span>], str[<span class="number">1000005</span>];</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%s"</span>, s);</div><div class="line">	<span class="keyword">int</span> cur, i, l = <span class="built_in">strlen</span>(s);</div><div class="line">	<span class="keyword">for</span> (cur = <span class="number">1</span>, i = <span class="number">0</span>; i &lt; l; cur = trie[cur][s[i++]-<span class="string">'a'</span>])</div><div class="line">		<span class="keyword">if</span> (!trie[cur][s[i]-<span class="string">'a'</span>])	trie[cur][s[i]-<span class="string">'a'</span>] = ++cnt;</div><div class="line">	tag[cur]++;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">BFS</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> head = <span class="number">0</span>, tail = <span class="number">1</span>;</div><div class="line">	que[head] = <span class="number">1</span>;</div><div class="line">	<span class="keyword">while</span> (head &lt; tail) &#123;</div><div class="line">		<span class="keyword">int</span> u = que[head++];</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) &#123;</div><div class="line">			<span class="keyword">if</span> (trie[u][i]) &#123;</div><div class="line">				que[tail++] = trie[u][i];</div><div class="line">				fail[trie[u][i]] = trie[fail[u]][i];</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				trie[u][i] = trie[fail[u]][i];</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>, cur = <span class="number">1</span>, index;</div><div class="line">	<span class="keyword">int</span> len = <span class="built_in">strlen</span>(str);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</div><div class="line">		flag[cur] = <span class="number">1</span>;</div><div class="line">		index = str[i]-<span class="string">'a'</span>;</div><div class="line">		<span class="keyword">while</span> (!trie[cur][index])	cur = fail[cur];</div><div class="line">		cur = trie[cur][index];</div><div class="line">		<span class="keyword">if</span> (flag[cur])	<span class="keyword">continue</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = cur; j; j = fail[j]) &#123;</div><div class="line">			ret += tag[j];</div><div class="line">			tag[j] = <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ret);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> T, n;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++)	trie[<span class="number">0</span>][i] = <span class="number">1</span>;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;T);</div><div class="line">	<span class="keyword">while</span> (T--) &#123;</div><div class="line">		cnt = <span class="number">1</span>;</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)	insert();</div><div class="line">		BFS();</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%s"</span>, str);</div><div class="line">		query();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= cnt; i++) &#123;</div><div class="line">			tag[i] = fail[i] = flag[i] = <span class="number">0</span>;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">26</span>; j++)</div><div class="line">				trie[i][j] = <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HDU3065和这道题很像，也是几乎裸的模板<br>&gt;<br>【HDU3065】病毒侵袭持续中<br>Time Limit: 2000/1000 MS (Java/Others)<br>Memory Limit: 32768/32768 K (Java/Others)<br>&gt;<br>Problem Description<br>小t非常感谢大家帮忙解决了他的上一个问题。然而病毒侵袭持续中。在小t的不懈努力下，他发现了网路中的“万恶之源”。这是一个庞大的病毒网站，他有着好多好多的病毒，但是这个网站包含的病毒很奇怪，这些病毒的特征码很短，而且只包含“英文大写字符”。当然小t好想好想为民除害，但是小t从来不打没有准备的战争。知己知彼，百战不殆，小t首先要做的是知道这个病毒网站特征：包含多少不同的病毒，每种病毒出现了多少次。大家能再帮帮他吗？<br>&gt;<br>Input<br>第一行，一个整数N（1&lt;=N&lt;=1000），表示病毒特征码的个数。<br>接下来N行，每行表示一个病毒特征码，特征码字符串长度在1—50之间，并且只包含“英文大写字符”。任意两个病毒特征码，不会完全相同。<br>在这之后一行，表示“万恶之源”网站源码，源码字符串长度在2000000之内。字符串中字符都是ASCII码可见字符（不包括回车）。<br>Output<br>按以下格式每行一个，输出每个病毒出现次数。未出现的病毒不需要输出。<br>病毒特征码: 出现次数<br>冒号后有一个空格，按病毒特征码的输入顺序进行输出。<br>&gt;<br>Sample Input<br>3<br>AA<br>BB<br>CC<br>ooxxCC%dAAAoen….END<br>Sample Output<br>AA: 2<br>CC: 1<br>&gt;<br>Hint<br>题目描述中没有被提及的所有情况都应该进行考虑。比如两个病毒特征码可能有相互包含或者有重叠的特征码段。<br>计数策略也可一定程度上从Sample中推测。</p>
<p>AC代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_N 1000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_LETTER 100000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> DICNUM 26</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">int</span> n, cnt;</div><div class="line"><span class="keyword">int</span> child[MAX_LETTER+<span class="number">5</span>][DICNUM], id[MAX_LETTER+<span class="number">5</span>], fail[MAX_LETTER+<span class="number">5</span>], ans[MAX_N+<span class="number">5</span>];</div><div class="line"><span class="keyword">int</span> que[MAX_LETTER+<span class="number">5</span>];</div><div class="line"><span class="keyword">char</span> s[<span class="number">2000005</span>], dic[<span class="number">1005</span>][<span class="number">55</span>];</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">	cnt = <span class="number">1</span>;</div><div class="line">	<span class="built_in">memset</span>(child, <span class="number">0</span>, <span class="keyword">sizeof</span>(child));</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; DICNUM; i++)	child[<span class="number">0</span>][i] = <span class="number">1</span>;</div><div class="line">	<span class="built_in">memset</span>(id, <span class="number">0</span>, <span class="keyword">sizeof</span>(id));</div><div class="line">	<span class="built_in">memset</span>(fail, <span class="number">0</span>, <span class="keyword">sizeof</span>(fail));</div><div class="line">	<span class="built_in">memset</span>(ans, <span class="number">0</span>, <span class="keyword">sizeof</span>(ans));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++) &#123;</div><div class="line">		<span class="keyword">int</span> cur = <span class="number">1</span>, l = <span class="built_in">strlen</span>(dic[j]);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; l; cur = child[cur][dic[j][i++]-<span class="string">'A'</span>])</div><div class="line">			<span class="keyword">if</span> (!child[cur][dic[j][i]-<span class="string">'A'</span>])	child[cur][dic[j][i]-<span class="string">'A'</span>] = ++cnt;</div><div class="line">		id[cur] = j;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setFail</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> head = <span class="number">0</span>, tail = <span class="number">1</span>;</div><div class="line">	que[head] = <span class="number">1</span>;</div><div class="line">	<span class="keyword">while</span> (head &lt; tail) &#123;</div><div class="line">		<span class="keyword">int</span> u = que[head++];</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; DICNUM; i++) &#123;</div><div class="line">			<span class="keyword">if</span> (child[u][i]) &#123;</div><div class="line">				que[tail++] = child[u][i];</div><div class="line">				<span class="keyword">int</span> cur = fail[u];</div><div class="line">				<span class="keyword">while</span> (!child[cur][i])	cur = fail[cur];</div><div class="line">				fail[child[u][i]] = child[cur][i];</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				child[u][i] = child[fail[u]][i];</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> cur = <span class="number">1</span>, index, l = <span class="built_in">strlen</span>(s);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</div><div class="line">		index = s[i]-<span class="string">'A'</span>;</div><div class="line">		<span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; <span class="number">25</span>) &#123;</div><div class="line">			cur = <span class="number">1</span>;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">while</span> (!child[cur][index])	cur = fail[cur];</div><div class="line">			cur = child[cur][index];</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = cur; j; j = fail[j])</div><div class="line">			<span class="keyword">if</span> (id[j])</div><div class="line">				ans[id[j]]++;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n) != EOF) &#123;</div><div class="line">		init();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)	<span class="built_in">scanf</span>(<span class="string">"%s"</span>, dic[i]);</div><div class="line">		insert();</div><div class="line">		setFail();</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%s"</span>, s);</div><div class="line">		query();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">			<span class="keyword">if</span> (ans[i])</div><div class="line">				<span class="built_in">printf</span>(<span class="string">"%s: %d\n"</span>, dic[i], ans[i]);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这两道题用我拙劣的写法还可以过，但是HDU2896就过不了</p>
<blockquote>
<p>【HDU2896】病毒侵袭<br>Time Limit: 2000/1000 MS (Java/Others)<br>Memory Limit: 32768/32768 K (Java/Others)</p>
<p>Problem Description<br>当太阳的光辉逐渐被月亮遮蔽，世界失去了光明，大地迎来最黑暗的时刻。。。。在这样的时刻，人们却异常兴奋——我们能在有生之年看到500年一遇的世界奇观，那是多么幸福的事儿啊~~<br>但网路上总有那么些网站，开始借着民众的好奇心，打着介绍日食的旗号，大肆传播病毒。小t不幸成为受害者之一。小t如此生气，他决定要把世界上所有带病毒的网站都找出来。当然，谁都知道这是不可能的。小t却执意要完成这不能的任务，他说：“子子孙孙无穷匮也！”（愚公后继有人了）。<br>万事开头难，小t收集了好多病毒的特征码，又收集了一批诡异网站的源码，他想知道这些网站中哪些是有病毒的，又是带了怎样的病毒呢？顺便还想知道他到底收集了多少带病毒的网站。这时候他却不知道何从下手了。所以想请大家帮帮忙。小t又是个急性子哦，所以解决问题越快越好哦~~</p>
<p>Input<br>第一行，一个整数N（1&lt;=N&lt;=500），表示病毒特征码的个数。<br>接下来N行，每行表示一个病毒特征码，特征码字符串长度在20—200之间。<br>每个病毒都有一个编号，依此为1—N。<br>不同编号的病毒特征码不会相同。<br>在这之后一行，有一个整数M（1&lt;=M&lt;=1000），表示网站数。<br>接下来M行，每行表示一个网站源码，源码字符串长度在7000—10000之间。<br>每个网站都有一个编号，依此为1—M。<br>以上字符串中字符都是ASCII码可见字符（不包括回车）。<br>Output<br>依次按如下格式输出按网站编号从小到大输出，带病毒的网站编号和包含病毒编号，每行一个含毒网站信息。<br>web 网站编号: 病毒编号 病毒编号 …<br>冒号后有一个空格，病毒编号按从小到大排列，两个病毒编号之间用一个空格隔开，如果一个网站包含病毒，病毒数不会超过3个。<br>最后一行输出统计信息，如下格式<br>total: 带病毒网站数<br>冒号后有一个空格。</p>
<p>Sample Input<br>3<br>aaa<br>bbb<br>ccc<br>2<br>aaabbbccc<br>bbaacc<br>Sample Output<br>web 1: 1 2 3<br>total: 1</p>
</blockquote>
<p>AC代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AC</span> &#123;</span></div><div class="line">	<span class="keyword">int</span> child[<span class="number">200</span>*<span class="number">500</span>+<span class="number">500</span>][<span class="number">128</span>], fail[<span class="number">200</span>*<span class="number">500</span>+<span class="number">500</span>], end[<span class="number">200</span>*<span class="number">500</span>+<span class="number">500</span>];</div><div class="line">	<span class="keyword">int</span> root, cnt;</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">newnode</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">128</span>; i++)	child[cnt][i] = <span class="number">-1</span>;</div><div class="line">		end[cnt++] = <span class="number">-1</span>;</div><div class="line">		<span class="keyword">return</span> cnt<span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">		cnt = <span class="number">0</span>;</div><div class="line">		root = newnode();</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">char</span> s[])</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> len = <span class="built_in">strlen</span>(s), cur = root;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; cur = child[cur][s[i++]])</div><div class="line">			<span class="keyword">if</span> (child[cur][s[i]] == <span class="number">-1</span>)	child[cur][s[i]] = newnode();</div><div class="line">		end[cur] = id;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setFail</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="built_in">queue</span> &lt;<span class="keyword">int</span>&gt; que;</div><div class="line">		fail[root] = root;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">128</span>; i++) &#123;</div><div class="line">			<span class="keyword">if</span> (child[root][i] == <span class="number">-1</span>) &#123;</div><div class="line">				child[root][i] = root;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				fail[child[root][i]] = root;</div><div class="line">				que.push(child[root][i]);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">while</span> (!que.empty()) &#123;</div><div class="line">			<span class="keyword">int</span> u = que.front();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">128</span>; i++) &#123;</div><div class="line">				<span class="keyword">if</span> (child[u][i] != <span class="number">-1</span>) &#123;</div><div class="line">					fail[child[u][i]] = child[fail[u]][i];</div><div class="line">					que.push(child[u][i]);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					child[u][i] = child[fail[u]][i];</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			que.pop();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">bool</span> flag[<span class="number">505</span>];</div><div class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> id, <span class="keyword">char</span> s[])</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> len = <span class="built_in">strlen</span>(s);</div><div class="line">		<span class="keyword">int</span> cur = root;</div><div class="line">		<span class="keyword">bool</span> mark = <span class="literal">false</span>;</div><div class="line">		<span class="built_in">memset</span>(flag, <span class="number">0</span>, <span class="keyword">sizeof</span>(flag));</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</div><div class="line">			cur = child[cur][s[i]];</div><div class="line">			<span class="keyword">int</span> tmp = cur;</div><div class="line">			<span class="keyword">while</span> (tmp != root) &#123;</div><div class="line">				<span class="keyword">if</span> (end[tmp] != <span class="number">-1</span>)	flag[end[tmp]] = mark = <span class="literal">true</span>;</div><div class="line">				tmp = fail[tmp];</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!mark)	<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"web %d:"</span>, id);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</div><div class="line">			<span class="keyword">if</span> (flag[i])</div><div class="line">				<span class="built_in">printf</span>(<span class="string">" %d"</span>, i);</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">	&#125;</div><div class="line">&#125; ac;</div><div class="line"><span class="keyword">char</span> str[<span class="number">10005</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> n, m, ans;</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n) != EOF) &#123;</div><div class="line">		ac.init();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">			<span class="built_in">scanf</span>(<span class="string">"%s"</span>, str);</div><div class="line">			ac.insert(i, str);</div><div class="line">		&#125;</div><div class="line">		ac.setFail();</div><div class="line">		ans = <span class="number">0</span>;</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;m);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</div><div class="line">			<span class="built_in">scanf</span>(<span class="string">"%s"</span>, str);</div><div class="line">			ans += ac.query(n, i, str);</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"total: %d\n"</span>, ans);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来看一道稍微有些变化的题（虽然还是基础水题）</p>
<blockquote>
<p>【ZOJ3034】 Detect the Virus<br>One day, Nobita found that his computer is extremely slow. After several hours’ work, he finally found that it was a virus that made his poor computer slow and the virus was activated by a misoperation of opening an attachment of an email.<br>Nobita did use an outstanding anti-virus software, however, for some strange reason, this software did not check email attachments. Now Nobita decide to detect viruses in emails by himself.<br>To detect an virus, a virus sample (several binary bytes) is needed. If these binary bytes can be found in the email attachment (binary data), then the attachment contains the virus.<br>Note that attachments (binary data) in emails are usually encoded in base64. To encode a binary stream in base64, first write the binary stream into bits. Then take 6 bits from the stream in turn, encode these 6 bits into a base64 character according the following table:<br>That is, translate every 3 bytes into 4 base64 characters. If the original binary stream contains 3k + 1 bytes, where k is an integer, fill last bits using zero when encoding and append ‘==’ as padding. If the original binary stream contains 3k + 2 bytes, fill last bits using zero when encoding and append ‘=’ as padding. No padding is needed when the original binary stream contains 3k bytes. </p>
<p>Value    Encoding    Value    Encoding<br>0        A            32        g<br>1        B            33        h<br>2        C            34        i<br>3        D            35        j<br>4        E            36        k<br>5        F            37        l<br>6        G             38        m<br>7        H            39        n<br>8        I            40        o<br>9        J            41        p<br>10        K            42        q<br>11        L            43        r<br>12        M            44        s<br>13        N            45        t<br>14        O            46        u<br>15        P            47        v<br>16        Q            48        w<br>17        R            49        x<br>18        S            50        y<br>19        T            51        z<br>20        U            52        0<br>21        V            53        1<br>22        W            54        2<br>23        X            55        3<br>24        Y            56        4<br>25        Z            57        5<br>26        a            58        6<br>27        b            59        7<br>28        c            60        8<br>29        d            61        9<br>30        e            62        +<br>31        f            63        /</p>
<p>For example, to encode ‘hello’ into base64, first write ‘hello’ as binary bits, that is: 01101000 01100101 01101100 01101100 01101111<br>Then, take 6 bits in turn and fill last bits as zero as padding (zero padding bits are marked in bold): 011010 000110 010101 101100 011011 000110 111100<br>They are 26 6 21 44 27 6 60 in decimal. Look up the table above and use corresponding characters: aGVsbG8<br>Since original binary data contains 1 * 3 + 2 bytes, padding is needed, append ‘=’ and ‘hello’ is finally encoded in base64: aGVsbG8=<br>Section 5.2 of RFC 1521 describes how to encode a binary stream in base64 much more detailedly:<br>Here is a piece of ANSI C code that can encode binary data in base64. It contains a function, encode (infile, outfile), to encode binary file infile in base64 and output result to outfile.</p>
<p>Input<br>Input contains multiple cases (about 15, of which most are small ones). The first line of each case contains an integer N (0 &lt;= N &lt;= 512). In the next N distinct lines, each line contains a sample of a kind of virus, which is not empty, has not more than 64 bytes in binary and is encoded in base64. Then, the next line contains an integer M (1 &lt;= M &lt;= 128). In the following M lines, each line contains the content of a file to be detected, which is not empty, has no more than 2048 bytes in binary and is encoded in base64.<br>There is a blank line after each case.<br>Output<br>For each case, output M lines. The ith line contains the number of kinds of virus detected in the ith file.<br>Output a blank line after each case.</p>
<p>Sample Input<br>3<br>YmFzZTY0<br>dmlydXM=<br>dDog<br>1<br>dGVzdDogdmlydXMu</p>
<p>1<br>QA==<br>2<br>QA==<br>ICAgICAgICA=<br>Sample Output<br>2</p>
<p>1<br>0</p>
<p>Hint<br>In the first sample case, there are three virus samples: base64, virus and t: , the data to be checked is test: virus., which contains the second and the third, two virus samples.</p>
</blockquote>
<p>思路很简单，先解码，然后就是模板题了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> DICNUM 256</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ACautomation</span> &#123;</span></div><div class="line">	<span class="keyword">int</span> cnt, root;</div><div class="line">	<span class="keyword">int</span> child[<span class="number">50000</span>+<span class="number">50</span>][DICNUM], end[<span class="number">50000</span>+<span class="number">50</span>], fail[<span class="number">50000</span>+<span class="number">50</span>];</div><div class="line">	<span class="keyword">int</span> Map[<span class="number">256</span>];</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">newnode</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; DICNUM; i++)	child[cnt][i] = <span class="number">-1</span>;</div><div class="line">		end[cnt++] = <span class="number">-1</span>;</div><div class="line">		<span class="keyword">return</span> cnt<span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">		cnt = <span class="number">0</span>;</div><div class="line">		root = newnode();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++)	Map[i+<span class="string">'A'</span>] = i;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">26</span>; i &lt; <span class="number">52</span>; i++)	Map[i<span class="number">-26</span>+<span class="string">'a'</span>] = i;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">52</span>; i &lt; <span class="number">62</span>; i++)	Map[i<span class="number">-52</span>+<span class="string">'0'</span>] = i;</div><div class="line">		Map[<span class="string">'+'</span>] = <span class="number">62</span>, Map[<span class="string">'/'</span>] = <span class="number">63</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> tmp[<span class="number">5000</span>+<span class="number">5</span>], tmpl;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ReEncode</span><span class="params">(<span class="keyword">char</span> s[])</span> </span>&#123;</div><div class="line">		<span class="built_in">memset</span>(tmp, <span class="number">0</span>, <span class="keyword">sizeof</span>(tmp));</div><div class="line">		tmpl = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, len = <span class="number">0</span>, x = <span class="number">0</span>; s[i] &amp;&amp; s[i] != <span class="string">'='</span>; i++) &#123;</div><div class="line">			len += <span class="number">6</span>, x = (x&lt;&lt;<span class="number">6</span>)|Map[s[i]];</div><div class="line">			<span class="keyword">if</span> (len &gt;= <span class="number">8</span>) &#123;</div><div class="line">				tmp[tmpl++] = (x&gt;&gt;(len<span class="number">-8</span>))&amp;<span class="number">0xff</span>;</div><div class="line">				len -= <span class="number">8</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">char</span> s[])</span> </span>&#123;</div><div class="line">		ReEncode(s);</div><div class="line">		<span class="keyword">int</span> cur = root;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tmpl; cur = child[cur][tmp[i++]])</div><div class="line">			<span class="keyword">if</span> (child[cur][tmp[i]] == <span class="number">-1</span>)	child[cur][tmp[i]] = newnode();</div><div class="line">		end[cur] = id;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setFail</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="built_in">queue</span> &lt;<span class="keyword">int</span>&gt; que;</div><div class="line">		fail[root] = root;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; DICNUM; i++) &#123;</div><div class="line">			<span class="keyword">if</span> (child[root][i] == <span class="number">-1</span>) &#123;</div><div class="line">				child[root][i] = root;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				fail[child[root][i]] = root;</div><div class="line">				que.push(child[root][i]);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">while</span> (!que.empty()) &#123;</div><div class="line">			<span class="keyword">int</span> cur = que.front();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; DICNUM; i++) &#123;</div><div class="line">				<span class="keyword">if</span> (child[cur][i] == <span class="number">-1</span>) &#123;</div><div class="line">					child[cur][i] = child[fail[cur]][i];</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					fail[child[cur][i]] = child[fail[cur]][i];</div><div class="line">					que.push(child[cur][i]);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			que.pop();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">bool</span> flag[<span class="number">50000</span>+<span class="number">50</span>];</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">char</span> s[])</span> </span>&#123;</div><div class="line">		ReEncode(s);</div><div class="line">		<span class="keyword">int</span> cur = root, ret = <span class="number">0</span>;</div><div class="line">		<span class="built_in">memset</span>(flag, <span class="number">0</span>, <span class="keyword">sizeof</span>(flag));</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tmpl; i++) &#123;</div><div class="line">			cur = child[cur][tmp[i]];</div><div class="line">			<span class="keyword">int</span> t = cur;</div><div class="line">			<span class="keyword">while</span> (t != root) &#123;</div><div class="line">				<span class="keyword">if</span> (end[t] != <span class="number">-1</span> &amp;&amp; !flag[end[t]])	ret++, flag[end[t]] = <span class="literal">true</span>;</div><div class="line">				t = fail[t];</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> ret;</div><div class="line">	&#125; </div><div class="line">&#125; ACauto;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> n, m;</div><div class="line">	<span class="keyword">char</span> str[<span class="number">5000</span>+<span class="number">5</span>];</div><div class="line">	<span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n) != EOF) &#123;</div><div class="line">		ACauto.init();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</div><div class="line">			<span class="built_in">scanf</span>(<span class="string">"%s"</span>, str);</div><div class="line">			ACauto.insert(i, str);</div><div class="line">		&#125;</div><div class="line">		ACauto.setFail();</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;m);</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</div><div class="line">			<span class="built_in">scanf</span>(<span class="string">"%s"</span>, str);</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ACauto.query(i, str));</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AC自动机的玄学博大精深，还可以和dp扯上关系，还是多练题为好</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AC自动机/">AC自动机</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/8/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/10/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 Azrael_Death
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
  </script>
  <script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  
</footer>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>
<!--
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
-->



  </div>
</body>
</html>